name: Rebuild Database (DB Swap)

# Creates a new D1 database, loads data optimally, then opens a PR to swap the binding.
# This avoids write amplification from INSERT OR REPLACE on the live database.
#
# Benefits:
# - Zero writes to active production DB during rebuild
# - Eliminates index/FTS maintenance overhead during bulk load
# - PR-based switchover for review and controlled deployment
# - Trivial rollback (just keep the old DB)
# - Ideal for dev iterations when schema/FTS is changing frequently

on:
  workflow_dispatch:
    inputs:
      database:
        description: 'Which database to rebuild'
        type: choice
        required: true
        options:
          - forward
          - reverse
      db_suffix:
        description: 'New database suffix (e.g., v42, 2024-01-15)'
        type: string
        required: true

jobs:
  rebuild:
    uses: ./.github/workflows/rebuild-db-reusable.yml
    with:
      database_type: ${{ inputs.database }}
      db_suffix: ${{ inputs.db_suffix }}
    secrets: inherit
